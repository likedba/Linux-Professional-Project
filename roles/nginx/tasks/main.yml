- name: Install Nginx
  apt:
    name: nginx
    state: present
    update_cache: yes
  tags: nginx

- name: Generate self-signed SSL certificate
  command:
    cmd: |
      openssl req -x509 -nodes -days 365 -newkey rsa:2048         -keyout /etc/ssl/private/nginx-selfsigned.key         -out /etc/ssl/certs/nginx-selfsigned.crt         -subj "/C=RU/ST=Moscow/L=Moscow/O=Company/CN=localhost"
    creates: /etc/ssl/certs/nginx-selfsigned.crt
  register: ssl_cert
  changed_when: ssl_cert.rc == 0
  tags: nginx

- name: Ensure SSL directories exist
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - /etc/ssl/certs
    - /etc/ssl/private
  tags: nginx

- name: Copy Nginx config for load balancing
  template:
    src: nginx-balancer.conf.j2
    dest: /etc/nginx/sites-available/wordpress
  notify: restart nginx
  tags: nginx

- name: Remove default Nginx site
  file:
    path: /etc/nginx/sites-enabled/default
    state: absent
  notify: restart nginx
  tags: nginx

- name: Enable WordPress site
  file:
    src: /etc/nginx/sites-available/wordpress
    dest: /etc/nginx/sites-enabled/wordpress
    state: link
    force: yes
  notify: restart nginx
  tags: nginx

- name: Test nginx configuration
  command: nginx -t
  register: nginx_test
  changed_when: false
  failed_when: nginx_test.rc != 0
  notify: restart nginx
  tags: nginx

- name: Allow ports 80 and 443
  ufw:
    rule: allow
    port: "{{ item }}"
    proto: tcp
  loop:
    - 80
    - 443
  tags: nginx,firewall

- name: Ensure Nginx is running and enabled
  systemd:
    name: nginx
    state: started
    enabled: yes
    daemon_reload: yes
  tags: nginx
