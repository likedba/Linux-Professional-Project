- name: Install GnuPG for Zabbix repository
  apt:
    name: gnupg
    state: present
  tags: zabbix-agent

- name: Download Zabbix GPG key
  get_url:
    url: https://repo.zabbix.com/zabbix-official-repo.key
    dest: /usr/share/keyrings/zabbix.asc
    mode: '0644'
  register: zabbix_gpg_key
  tags: zabbix-agent

- name: Dearmor Zabbix GPG key
  command: gpg --dearmor -o /usr/share/keyrings/zabbix.gpg /usr/share/keyrings/zabbix.asc
  when: zabbix_gpg_key.changed
  tags: zabbix-agent

- name: Ensure Zabbix GPG key permissions
  file:
    path: /usr/share/keyrings/zabbix.gpg
    mode: '0644'
  tags: zabbix-agent

- name: Add Zabbix repository
  apt_repository:
    repo: "deb [signed-by=/usr/share/keyrings/zabbix.gpg] https://repo.zabbix.com/zabbix/7.0/ubuntu {{ ansible_distribution_release }} main"
    state: present
  tags: zabbix-agent

- name: Install Zabbix agent2
  apt:
    name: zabbix-agent2
    state: present
  tags: zabbix-agent

- name: Install Zabbix agent2 PostgreSQL plugin on database hosts
  apt:
    name: zabbix-agent2-plugin-postgresql
    state: present
  when: "'database' in group_names"
  tags: zabbix-agent

- name: Configure Zabbix agent2 server settings
  lineinfile:
    path: /etc/zabbix/zabbix_agent2.conf
    regexp: "^{{ item.key }}="
    line: "{{ item.key }}={{ item.value }}"
  loop:
    - { key: "Server", value: "{{ zabbix_server_ip }}" }
    - { key: "ServerActive", value: "{{ zabbix_server_ip }}" }
    - { key: "Hostname", value: "{{ inventory_hostname }}" }
  tags: zabbix-agent

- name: Ensure Zabbix agent2 is running and enabled
  systemd:
    name: zabbix-agent2
    state: started
    enabled: yes
  tags: zabbix-agent
