- name: Install GnuPG
  apt:
    name: gnupg
    state: present

- name: Download Zabbix GPG key
  get_url:
    url: https://repo.zabbix.com/zabbix-official-repo.key
    dest: /usr/share/keyrings/zabbix.asc
    mode: '0644'
  register: zabbix_gpg_key

- name: Dearmor Zabbix GPG key
  command: gpg --dearmor -o /usr/share/keyrings/zabbix.gpg /usr/share/keyrings/zabbix.asc
  when: zabbix_gpg_key.changed

- name: Ensure Zabbix GPG key permissions
  file:
    path: /usr/share/keyrings/zabbix.gpg
    mode: '0644'

- name: Add Zabbix repository
  apt_repository:
    repo: "deb [signed-by=/usr/share/keyrings/zabbix.gpg] https://repo.zabbix.com/zabbix/7.0/ubuntu {{ ansible_distribution_release }} main"
    state: present
    update_cache: yes

- name: Install Zabbix server, frontend, agent
  apt:
    name:
      - postgresql
      - python3-psycopg2
      - zabbix-server-pgsql
      - zabbix-frontend-php
      - zabbix-apache-conf
      - zabbix-sql-scripts
      - zabbix-agent
      - libapache2-mod-php
    state: present

- name: Ensure PostgreSQL is running and enabled
  systemd:
    name: postgresql
    state: started
    enabled: yes

- name: Check if Zabbix database user exists
  command: "sudo -u postgres psql -tAc \"SELECT 1 FROM pg_roles WHERE rolname='{{ zabbix_db_user }}'\""
  register: zabbix_db_user_check
  changed_when: false
  become: yes

- name: Create Zabbix database user
  command: "sudo -u postgres psql -c \"CREATE USER {{ zabbix_db_user }} WITH PASSWORD '{{ zabbix_db_password }}'\""
  when: zabbix_db_user_check.stdout.strip() != "1"
  become: yes

- name: Check if Zabbix database exists
  command: "sudo -u postgres psql -tAc \"SELECT 1 FROM pg_database WHERE datname='{{ zabbix_db_name }}'\""
  register: zabbix_db_check
  changed_when: false
  become: yes

- name: Create Zabbix database
  command: "sudo -u postgres psql -c \"CREATE DATABASE {{ zabbix_db_name }} OWNER {{ zabbix_db_user }} ENCODING 'UTF8'\""
  when: zabbix_db_check.stdout.strip() != "1"
  become: yes

- name: Ensure Zabbix database owner is zabbix
  command: "sudo -u postgres psql -c \"ALTER DATABASE {{ zabbix_db_name }} OWNER TO {{ zabbix_db_user }}\""
  become: yes

- name: Grant Zabbix privileges on public tables
  command: "sudo -u postgres psql -d {{ zabbix_db_name }} -c \"GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO {{ zabbix_db_user }};\""
  become: yes

- name: Grant Zabbix privileges on public sequences
  command: "sudo -u postgres psql -d {{ zabbix_db_name }} -c \"GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO {{ zabbix_db_user }};\""
  become: yes

- name: Grant Zabbix privileges on public functions
  command: "sudo -u postgres psql -d {{ zabbix_db_name }} -c \"GRANT ALL PRIVILEGES ON ALL FUNCTIONS IN SCHEMA public TO {{ zabbix_db_user }};\""
  become: yes

- name: Check if Zabbix schema is loaded
  command: "sudo -u postgres psql -tAc \"SELECT 1 FROM information_schema.tables WHERE table_name='users'\" {{ zabbix_db_name }}"
  register: zabbix_schema_check
  changed_when: false
  become: yes

- name: Import Zabbix database schema
  shell: "sudo -u postgres bash -lc \"zcat /usr/share/zabbix-sql-scripts/postgresql/server.sql.gz | psql {{ zabbix_db_name }}\""
  when: zabbix_schema_check.stdout.strip() != "1"
  become: yes

- name: Configure Zabbix server database settings
  lineinfile:
    path: /etc/zabbix/zabbix_server.conf
    regexp: "^{{ item.key }}="
    line: "{{ item.key }}={{ item.value }}"
  loop:
    - { key: "DBName", value: "{{ zabbix_db_name }}" }
    - { key: "DBUser", value: "{{ zabbix_db_user }}" }
    - { key: "DBPassword", value: "{{ zabbix_db_password }}" }

- name: Detect PHP version for Apache configuration
  command: 'php -r ''echo PHP_MAJOR_VERSION.".".PHP_MINOR_VERSION;'''
  register: zabbix_php_version
  changed_when: false

- name: Ensure PHP module is enabled for Apache
  command: "a2enmod php{{ zabbix_php_version.stdout }}"
  args:
    creates: "/etc/apache2/mods-enabled/php{{ zabbix_php_version.stdout }}.load"

- name: Set PHP timezone for Apache
  ini_file:
    path: "/etc/php/{{ zabbix_php_version.stdout }}/apache2/php.ini"
    section: Date
    option: date.timezone
    value: "{{ zabbix_php_timezone }}"

- name: Set PHP timezone for CLI
  ini_file:
    path: "/etc/php/{{ zabbix_php_version.stdout }}/cli/php.ini"
    section: Date
    option: date.timezone
    value: "{{ zabbix_php_timezone }}"

- name: Remove php_value timezone from Zabbix Apache config
  lineinfile:
    path: /etc/zabbix/apache.conf
    regexp: '^php_value\[date.timezone\]'
    state: absent

- name: Ensure Zabbix server unit uses Type=simple
  lineinfile:
    path: /usr/lib/systemd/system/zabbix-server.service
    regexp: '^Type='
    line: 'Type=simple'

- name: Remove ExecStop from Zabbix server unit
  lineinfile:
    path: /usr/lib/systemd/system/zabbix-server.service
    regexp: '^ExecStop='
    state: absent

- name: Reload systemd for Zabbix server unit changes
  systemd:
    daemon_reload: yes

- name: Ensure Zabbix server is running and enabled
  systemd:
    name: zabbix-server
    state: started
    enabled: yes

- name: Ensure Zabbix agent is running and enabled
  systemd:
    name: zabbix-agent
    state: started
    enabled: yes

- name: Ensure Apache is running and enabled
  systemd:
    name: apache2
    state: started
    enabled: yes
